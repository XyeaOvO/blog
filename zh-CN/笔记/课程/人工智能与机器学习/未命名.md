你现在在一个**只经过uv init animeface-gan的项目目录**里。请你**自行执行命令并创建所有必要文件**，把项目从 0 搭建到可以在 AnimeFace128 数据集上**跑通一个最小可用 GAN(DCGAN) 训练**，并满足下面所有规范与验收标准。默认使用 **Linux/macOS shell**。我已经安装了 `uv`。

需要实现：环境搭建、数据集获取、DCGAN 训练、wandb 记录、hydra 配置化、产物落盘到 outputs/时间戳目录、wandb sweep 超参搜索模板。

---

## 一、强制工程规范（必须全部满足）

### 1) 技术栈

- 配置：**Hydra**
- 训练框架：**PyTorch Lightning**
- 实验记录：**Weights & Biases (wandb)**
- 代码规范：**Ruff** + **pre-commit**
- Git 规范：**Git flow** + **Conventional Commits**（及时commit！）
- 环境管理：**uv**
- 评估指标：**torch-fidelity** (用于计算 FID/IS)
    
### 2) 目录结构

```
data/                          # 数据集存放位置
src/                           # 所有代码
conf/                          # hydra 配置
outputs/YYYY-MM-DD/HH-mm-ss/   # 所有训练产物（Hydra 管）
```

要求：运行训练后，Lightning 的 checkpoint、wandb 离线缓存、生成样例图等都应在该 outputs 时间戳目录下（或其子目录）。

### 3) 超参搜索
- 使用 **wandb sweep**
- 在 `conf/sweeps/` 提供至少一个 sweep 配置（例如针对 lr、z_dim、g/d feature、batch_size 等）
- 提供一键启动 sweep 的脚本（例如 `scripts/sweep.sh`）以及 README 说明

### 4) 深度学习代码规范：张量形状管理 SOP（必须落地到代码）

你必须在项目中安装并使用：

```bash
pip install jaxtyping typeguard einops torch-fidelity modelscope
```

并落实以下规则（需要在代码与 README 中体现）：

- 核心接口禁止 `Dict[str, Tensor]` / `Tuple[Tensor,...]` 传递复杂输入，改用 dataclass
    
- 用 `jaxtyping` 标注 tensor 形状（RGB 通道写死 3）
    
- 调试阶段关键 forward 用 `@typechecked`
    
- 禁止随意 `view/permute/transpose` 做隐式变换；维度变换必须优先用 `einops.rearrange/reduce` 并显式写模式
    
- 中间变量命名尽量体现维度（如 `x_bchw`）
    

---

## 二、数据集：AnimeFace128（必须能自动准备）

数据集来源：ModelScope `yanghaitao/AnimeFace128`，图片 128x128。  
要求：

- 默认把数据放在 `data/animeface128/`
- 如果数据目录不存在或为空，提供代码应该自动下载
```
#数据集下载
from modelscope.msdatasets import MsDataset
ds =  MsDataset.load('yanghaitao/AnimeFace128', subset_name='default', split='train')
#您可按需配置 subset_name、split，参照“快速使用”示例代码
```
- dataset / datamodule 代码在 `src/` 中，训练入口自动检查数据是否就绪，否则给出明确提示

---

## 三、模型与训练：适配 128px 的 DCGAN（必须跑通且稳定）

- 训练目标：从随机噪声生成 128x128 RGB anime face
- **架构要求**：
    - Generator 和 Discriminator 必须适配 128x128 输入输出（通常比标准 DCGAN 多一层）。
    - 建议在 Discriminator 中使用 **Spectral Normalization** (谱归一化) 或类似机制以稳定训练（避免作业演示时模型崩溃）。
- **指标评估（作业核心要求）**：
    - 实现一个回调 (Callback) 或 验证 step，在训练结束或每 N 个 epoch 调用 `torch-fidelity` 计算 **FID (Fréchet Inception Distance)** 和 **IS (Inception Score)**。
    - 指标需记录到 wandb。
    - 如果训练时计算太慢，需提供一个 `scripts/eval.py` 脚本，加载 checkpoint 对生成图像进行离线评估。
- 训练过程中：定期保存生成样例图（grid），写入 `outputs/.../samples/`
    

---

## 四、Hydra 配置

- `conf/config.yaml` 为入口，包含：
    
    - dataset 配置（root、num_workers 等）
        
    - model 配置（z_dim、feature_maps 等）
        
    - trainer 配置（max_epochs、precision、accelerator、devices）
        
    - logging 配置（wandb 项目名、实体、离线/在线）
        
    - 复现实验 seed
        
- 设置 Hydra 输出目录为：
    
    - `outputs/${now:%Y-%m-%d}/${now:%H-%M-%S}`
        
- 训练入口通过 `python -m ...` 启动，并能用 hydra override（例如 `trainer.max_epochs=1`）
    

---

## 五、工程交付物清单

1. `pyproject.toml`：包含项目元信息与依赖（pytorch、lightning、hydra-core、wandb、torchvision、Pillow、tqdm、jaxtyping、typeguard、einops、ruff、torch-fidelity modelscope等）
    
2. `README.md`：必须包含
    
    - 环境创建/安装（uv）
        
    - 数据下载方式（自动 + 手动）
        
    - 训练运行命令（最小跑通：1 epoch）
        
    - wandb 使用方式（含 offline）
        
    - wandb sweep 运行方式
        
    - Git flow + Conventional Commits 简述
        
    - 张量形状 SOP 简述（并指出代码中如何实践）
        
3. `.pre-commit-config.yaml`：至少包含 ruff + ruff-format（可附加 end-of-file-fixer 等）
    
4. `ruff` 配置（在 `pyproject.toml` 或单独文件均可）
    
5. `src/` 下的可运行代码（建议包名如 `src/anime_gan/`）
    
    - `train.py`（hydra main 入口）
        
    - `data/`：dataset + LightningDataModule
        
    - `models/`：generator/discriminator
        
    - `lit/`：LightningModule（GAN training loop）
        
    - `utils/`：seed、image grid 保存、路径工具等
        
6. `conf/` 下的配置
    
    - `config.yaml`
        
    - 子配置（dataset/model/trainer/logger 等）
        
    - `conf/sweeps/dcgan.yaml`
        
7. `scripts/`
    
    - `train_debug.sh`（跑 1 epoch/少量 step 的 smoke test）
        
    - `sweep.sh`（启动 sweep agent 的示例）
	- `eval.py`: 用于加载训练好的模型，生成 50k 张图片并计算 FID/IS 的脚本（满足作业评估需求）。
        
8. 训练产物验证：提供说明如何运行后看到
    
    - `outputs/YYYY-MM-DD/HH-mm-ss/` 下出现 hydra 配置、checkpoints、samples 等
        

---

## 六、验收标准（你必须确保我按命令能复现）

你最后输出：

1. 项目结构树（tree）
    
2. 关键运行命令清单（复制即可运行）
    
3. “最小冒烟测试”：例如 CPU 下跑 `trainer.max_steps=20` 或 `max_epochs=1` 可以完成并生成 samples
    

---

## 七、实现细节约束

- 不要写空壳；必须真实可运行
    
- 默认兼容 CPU；如有 GPU 自动使用但不强依赖
    
- 生成器输出范围与图像保存要正确（[-1,1] 或 [0,1]，并在保存时反归一化）
    
- dataclass + jaxtyping + typeguard 必须实际用在关键接口（至少在数据输出与模型 forward 中）
    
- 张量变换尽量用 einops
    
- 所有路径以项目根目录为准，数据在 data/，训练产物严格在 outputs/时间戳下
    

---

## 现在开始执行：

请你自行创建文件、写代码、执行必要命令完成所有工程。完成后，把最终结果（结构树 + 运行命令 + 注意事项）输出给我。  
（你可以在过程中执行关联远程git remote add origin https://github.com/XyeaOvO/animeface-gan.git
git branch -M main，但不要 push；也不要依赖我手动补文件。）